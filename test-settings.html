<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings Manager Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #121212;
            color: white;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #333;
            border-radius: 8px;
            background: #1e1e1e;
        }
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
        }
        .success { background: #1a5f1a; }
        .error { background: #5f1a1a; }
        .info { background: #1a3a5f; }
        button {
            background: #00ffa3;
            color: black;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { opacity: 0.8; }
        input, select {
            background: #333;
            color: white;
            border: 1px solid #555;
            padding: 8px;
            border-radius: 4px;
            margin: 5px;
        }
    </style>
</head>
<body>
    <h1>ğŸ”§ ì¤‘ì•™í™”ëœ ì„¤ì • ê´€ë¦¬ ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸</h1>
    
    <div class="test-section">
        <h2>1. ì„¤ì • ê´€ë¦¬ì ì´ˆê¸°í™”</h2>
        <button onclick="initializeManager()">ì„¤ì • ê´€ë¦¬ì ì´ˆê¸°í™”</button>
        <div id="init-result"></div>
    </div>

    <div class="test-section">
        <h2>2. ì„¤ì •ê°’ ì½ê¸°/ì“°ê¸° í…ŒìŠ¤íŠ¸</h2>
        <div>
            <label>ë³¼ë¥¨: </label>
            <input type="range" id="volume" min="0" max="1" step="0.1" value="0.5" onchange="updateSetting('volume', this.value)">
            <span id="volume-display">0.5</span>
        </div>
        <div>
            <label>í´ë§ ê°„ê²©: </label>
            <input type="range" id="pollingInterval" min="5" max="60" step="1" value="15" onchange="updateSetting('pollingInterval', this.value)">
            <span id="pollingInterval-display">15</span>
        </div>
        <div>
            <label>í…ìŠ¤íŠ¸ ìƒ‰ìƒ: </label>
            <input type="color" id="textColor" value="#ffffff" onchange="updateSetting('textColor', this.value)">
        </div>
        <div>
            <label>ì•Œë¦¼ ë ˆì´ì•„ì›ƒ: </label>
            <select id="notificationLayout" onchange="updateSetting('notificationLayout', this.value)">
                <option value="vertical">ì„¸ë¡œí˜•</option>
                <option value="horizontal">ê°€ë¡œí˜•</option>
            </select>
        </div>
        <button onclick="getAllSettings()">ëª¨ë“  ì„¤ì • ì¡°íšŒ</button>
        <div id="settings-result"></div>
    </div>

    <div class="test-section">
        <h2>3. ë°°ì¹˜ ì„¤ì • ì—…ë°ì´íŠ¸ í…ŒìŠ¤íŠ¸</h2>
        <button onclick="testBatchUpdate()">ë°°ì¹˜ ì—…ë°ì´íŠ¸ ì‹¤í–‰</button>
        <div id="batch-result"></div>
    </div>

    <div class="test-section">
        <h2>4. ì„¤ì • ê²€ì¦ í…ŒìŠ¤íŠ¸</h2>
        <button onclick="testValidation()">ê²€ì¦ í…ŒìŠ¤íŠ¸ ì‹¤í–‰</button>
        <div id="validation-result"></div>
    </div>

    <div class="test-section">
        <h2>5. ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ í…ŒìŠ¤íŠ¸</h2>
        <button onclick="testLocalStorage()">ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ í…ŒìŠ¤íŠ¸</button>
        <div id="storage-result"></div>
    </div>

    <div class="test-section">
        <h2>6. ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ í…ŒìŠ¤íŠ¸</h2>
        <button onclick="testEventListeners()">ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ í…ŒìŠ¤íŠ¸</button>
        <div id="events-result"></div>
    </div>

    <script type="module">
        // Import the SettingsManager
        import { SettingsManager } from './src/lib/settingsManager.ts';
        
        let settingsManager = null;
        let eventLog = [];

        // Make functions available globally
        window.initializeManager = async function() {
            const resultDiv = document.getElementById('init-result');
            try {
                settingsManager = new SettingsManager('http://localhost:3001');
                
                // Add event listener for testing
                settingsManager.addListener((event) => {
                    eventLog.push(event);
                    console.log('Settings changed:', event);
                });

                // Load settings from various sources
                await settingsManager.loadFromStorage();
                settingsManager.loadFromURL();

                resultDiv.innerHTML = '<div class="test-result success">âœ… ì„¤ì • ê´€ë¦¬ì ì´ˆê¸°í™” ì„±ê³µ</div>';
                
                // Update UI with current settings
                updateUI();
            } catch (error) {
                resultDiv.innerHTML = `<div class="test-result error">âŒ ì´ˆê¸°í™” ì‹¤íŒ¨: ${error.message}</div>`;
            }
        };

        window.updateSetting = function(key, value) {
            if (!settingsManager) {
                alert('ë¨¼ì € ì„¤ì • ê´€ë¦¬ìë¥¼ ì´ˆê¸°í™”í•˜ì„¸ìš”');
                return;
            }

            try {
                // Convert value to appropriate type
                let convertedValue = value;
                if (key === 'volume') {
                    convertedValue = parseFloat(value);
                } else if (key === 'pollingInterval') {
                    convertedValue = parseInt(value);
                }

                const success = settingsManager.set(key, convertedValue);
                
                if (success) {
                    document.getElementById(`${key}-display`).textContent = convertedValue;
                    console.log(`Setting updated: ${key} = ${convertedValue}`);
                } else {
                    alert(`ì„¤ì • ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: ${key}`);
                }
            } catch (error) {
                alert(`ì„¤ì • ì—…ë°ì´íŠ¸ ì˜¤ë¥˜: ${error.message}`);
            }
        };

        window.getAllSettings = function() {
            if (!settingsManager) {
                alert('ë¨¼ì € ì„¤ì • ê´€ë¦¬ìë¥¼ ì´ˆê¸°í™”í•˜ì„¸ìš”');
                return;
            }

            const settings = settingsManager.getAll();
            const resultDiv = document.getElementById('settings-result');
            resultDiv.innerHTML = `
                <div class="test-result info">
                    <h4>í˜„ì¬ ì„¤ì •ê°’:</h4>
                    <pre>${JSON.stringify(settings, null, 2)}</pre>
                </div>
            `;
        };

        window.testBatchUpdate = function() {
            if (!settingsManager) {
                alert('ë¨¼ì € ì„¤ì • ê´€ë¦¬ìë¥¼ ì´ˆê¸°í™”í•˜ì„¸ìš”');
                return;
            }

            const batchSettings = {
                volume: 0.8,
                displayDuration: 10,
                textColor: '#ff6b6b',
                animationType: 'bounce'
            };

            try {
                const success = settingsManager.setMultiple(batchSettings);
                const resultDiv = document.getElementById('batch-result');
                
                if (success) {
                    resultDiv.innerHTML = `
                        <div class="test-result success">
                            âœ… ë°°ì¹˜ ì—…ë°ì´íŠ¸ ì„±ê³µ<br>
                            ì—…ë°ì´íŠ¸ëœ ì„¤ì •: ${Object.keys(batchSettings).join(', ')}
                        </div>
                    `;
                    updateUI();
                } else {
                    resultDiv.innerHTML = '<div class="test-result error">âŒ ë°°ì¹˜ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨</div>';
                }
            } catch (error) {
                document.getElementById('batch-result').innerHTML = 
                    `<div class="test-result error">âŒ ë°°ì¹˜ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜: ${error.message}</div>`;
            }
        };

        window.testValidation = function() {
            if (!settingsManager) {
                alert('ë¨¼ì € ì„¤ì • ê´€ë¦¬ìë¥¼ ì´ˆê¸°í™”í•˜ì„¸ìš”');
                return;
            }

            const testCases = [
                { key: 'volume', value: 1.5, shouldFail: true }, // ë²”ìœ„ ì´ˆê³¼
                { key: 'volume', value: 0.5, shouldFail: false }, // ì •ìƒ
                { key: 'animationType', value: 'invalid', shouldFail: true }, // ì˜ëª»ëœ ê°’
                { key: 'animationType', value: 'fade', shouldFail: false }, // ì •ìƒ
                { key: 'textColor', value: 'invalid', shouldFail: true }, // ì˜ëª»ëœ ìƒ‰ìƒ
                { key: 'textColor', value: '#ff0000', shouldFail: false }, // ì •ìƒ
            ];

            let results = [];
            testCases.forEach(testCase => {
                const success = settingsManager.set(testCase.key, testCase.value);
                const passed = testCase.shouldFail ? !success : success;
                results.push({
                    ...testCase,
                    success,
                    passed
                });
            });

            const resultDiv = document.getElementById('validation-result');
            const passedCount = results.filter(r => r.passed).length;
            
            resultDiv.innerHTML = `
                <div class="test-result ${passedCount === results.length ? 'success' : 'error'}">
                    <h4>ê²€ì¦ í…ŒìŠ¤íŠ¸ ê²°ê³¼: ${passedCount}/${results.length} í†µê³¼</h4>
                    ${results.map(r => 
                        `<div>${r.passed ? 'âœ…' : 'âŒ'} ${r.key}=${r.value} (ì˜ˆìƒ: ${r.shouldFail ? 'ì‹¤íŒ¨' : 'ì„±ê³µ'})</div>`
                    ).join('')}
                </div>
            `;
        };

        window.testLocalStorage = function() {
            if (!settingsManager) {
                alert('ë¨¼ì € ì„¤ì • ê´€ë¦¬ìë¥¼ ì´ˆê¸°í™”í•˜ì„¸ìš”');
                return;
            }

            try {
                // Test saving to localStorage
                settingsManager.set('volume', 0.7);
                settingsManager.set('textColor', '#00ff00');
                
                // Wait a bit for debounced save
                setTimeout(() => {
                    // Check if saved to localStorage
                    const saved = localStorage.getItem('fazzk-app-settings');
                    const resultDiv = document.getElementById('storage-result');
                    
                    if (saved) {
                        const parsedSettings = JSON.parse(saved);
                        resultDiv.innerHTML = `
                            <div class="test-result success">
                                âœ… ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ì €ì¥ ì„±ê³µ<br>
                                <pre>${JSON.stringify(parsedSettings, null, 2)}</pre>
                            </div>
                        `;
                    } else {
                        resultDiv.innerHTML = '<div class="test-result error">âŒ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ì €ì¥ ì‹¤íŒ¨</div>';
                    }
                }, 200);
            } catch (error) {
                document.getElementById('storage-result').innerHTML = 
                    `<div class="test-result error">âŒ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ í…ŒìŠ¤íŠ¸ ì˜¤ë¥˜: ${error.message}</div>`;
            }
        };

        window.testEventListeners = function() {
            if (!settingsManager) {
                alert('ë¨¼ì € ì„¤ì • ê´€ë¦¬ìë¥¼ ì´ˆê¸°í™”í•˜ì„¸ìš”');
                return;
            }

            // Clear event log
            eventLog = [];
            
            // Make some changes
            settingsManager.set('volume', 0.9);
            settingsManager.set('displayDuration', 8);
            settingsManager.setMultiple({
                textColor: '#ffff00',
                animationType: 'slide-up'
            });

            setTimeout(() => {
                const resultDiv = document.getElementById('events-result');
                resultDiv.innerHTML = `
                    <div class="test-result ${eventLog.length > 0 ? 'success' : 'error'}">
                        <h4>ì´ë²¤íŠ¸ ë¡œê·¸ (${eventLog.length}ê°œ ì´ë²¤íŠ¸):</h4>
                        ${eventLog.map(event => 
                            `<div>ğŸ”” ${event.key}: ${event.oldValue} â†’ ${event.newValue} (${event.source})</div>`
                        ).join('')}
                    </div>
                `;
            }, 100);
        };

        function updateUI() {
            if (!settingsManager) return;
            
            const settings = settingsManager.getAll();
            
            // Update form controls
            document.getElementById('volume').value = settings.volume;
            document.getElementById('volume-display').textContent = settings.volume;
            document.getElementById('pollingInterval').value = settings.pollingInterval;
            document.getElementById('pollingInterval-display').textContent = settings.pollingInterval;
            document.getElementById('textColor').value = settings.textColor;
            document.getElementById('notificationLayout').value = settings.notificationLayout;
        }

        // Auto-initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            console.log('Settings Manager Test Page Loaded');
        });
    </script>
</body>
</html>